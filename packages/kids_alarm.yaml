##########  ############################################################
##  Morning wakeup for the kids
## 
##
##
######################################################################
group:
  Alarm Clock:
    # hidecontrol: yes
    entities:
      - input_slider.slider_hours
      - input_slider.slider_minutes
      - input_boolean.alarmweekday
      - automation.alarm_clock
      - script.kids_tts_warn
      - script.kids_tts_wake

input_slider:
  slider_hours:
    name: Hours
    initial: 7
    min: 0
    max: 23
    step: 1

  slider_minutes:
    name: Minutes
    initial: 0
    min: 0
    max: 59
    step: 1

input_boolean:
  alarmweekday:
    name: Weekdays Only
    initial: off
    icon: mdi:alarm

###### SELECTORS
input_select:
  radio_station:
    name: Radio Station
    options:
      - "-"
      - Dancehall Link
      - Energy 98
      - Hit Remixes
      - Play Radio
      - 90s Hits
    initial: "-"
    icon: mdi:radio
  radio_station_location:
    name: Radio Location
    options:
      - Office
      - All Zones
    initial: "All Zones"
    icon: mdi:radio


##################################
## MQTT Alarm States
##################################

sensor:
  - platform: mqtt
    state_topic: "/home/inbed/kahlan"
    name: "Kahlan in Bed"
    value_template: "{{ value }}"
  - platform: mqtt
    state_topic: "/home/inbed/braelyn"
    name: "Braelyn in Bed"
    value_template: "{{ value }}"
  - platform: mqtt
    state_topic: "/home/inbed/kent"
    name: "Kent in Bed"
    value_template: "{{ value }}"
  - platform: mqtt
    state_topic: "/home/inbed/bennett"
    name: "Bennett in Bed"
    value_template: "{{ value }}"

###############################################################################
#  Automation - Saves Switch State to MQTT
###############################################################################
automation:
  - alias: Save Kid States to MQTT
    initial_state: true
    hide_entity: true
    trigger:
      platform: state
      entity_id: switch.switch_one, switch.switch_two, switch.switch_three, switch.switch_four, switch.switch_five
    action:
      service: mqtt.publish
      data_template:
        topic: "/home/inbed/{{ trigger.entity_id.split('.')[1] }}"
        retain: true
        qos: 1
        payload: '{{ trigger.to_state.state }}'

  - alias: "TTS Notification - Kids"
    # initial_state: False
    trigger:
      - platform: state
        entity_id: input_boolean.test_tts
        from: 'off'
        to: 'on'
    action:
      - service: script.kids_tts_warn


  - alias: 'Alarm Clock'
    trigger:
      platform: time
      minutes: '/1'
      seconds: 00
    condition:
      - condition: template
        value_template: >
          {% if states.sensor.time.state.split(':')[0] |int == states.input_slider.slider_hours.state |int %}
            true
          {% else %}
            false
          {% endif %}
      - condition: template
        value_template: >
          {% if states.sensor.time.state.split(':')[1]  |int == states.input_slider.slider_minutes.state |int %}
            true
          {% else %}
            false
          {% endif %}
    action:
      - service: script.kids_tts_wake


###########################################################
# Scripts
###########################################################

script:
    kids_tts_warn:
      sequence:
        - service: media_player.volume_set
          data_template:
            entity_id: media_player.volumio_tts
            volume_level: '0.7'      
        - service: tts.google_say
          data_template:
            entity_id: media_player.volumio_tts
            message: >
              It is about time to get up, you have 10 more minutes to sleep
        # - service: notify.slack__dev
        #   data_template:
        #     message: >
        #       It is about time to get up, you have 10 more minutes to see
    kids_tts_wake:
      sequence:
        - service: media_player.volume_set
          data_template:
            entity_id: media_player.volumio_tts
            volume_level: '0.7'
        - service: media_player.play_media
          data_template:
            entity_id: media_player.volumio_tts
            #media_content_id: "https://raw.githubusercontent.com/sixreeves/Home-AssistantConfig/master/sounds/two-tone-chime.mp3"
            #media_content_id: >
            {% if is_state('input_select.radio_station', 'Dancehall Link') %} http://stream.radio.co/s30d82be5e/listen
            {% elif is_state('input_select.radio_station', 'Energy 98') %} http://174.127.85.10:8800
            {% elif is_state('input_select.radio_station', 'Hit Remixes') %} http://149.56.23.7:20252/stream
            {% elif is_state('input_select.radio_station', 'Play Radio') %} http://176.9.31.78:8222
            {% elif is_state('input_select.radio_station', '90s Hits') %} http://rfcmedia.streamguys1.com/90hits.mp3
            {% endif %}
            media_content_id: "/data/INTERNAL/Alarm-Tone.mp3"
            media_content_type: audio/mp3     
        - service: tts.google_say
          data_template:
            entity_id: media_player.volumio_tts
            message: >
              {% set time = states('sensor.time_date') %}
              It is time to get up!! <break time='0.5s'/> Today is {{time}} <break time='0.5s'/> It is time to get up
        - service: notify.slack__dev
          data_template:
            message: >
              kids alarm is going off

